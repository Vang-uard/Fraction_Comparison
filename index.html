<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J9V1XR626F"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J9V1XR626F');
  </script>
  <meta name="google-adsense-account" content="ca-pub-9880204299534500">
  <title>ìˆ˜í•™ ê³„ì‚° ì—°ìŠµ</title>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 800px;
      padding: 0 10px;
    }
    h1 {
      margin: 0;
    }
    /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
    .nav {
      text-align: center;
      margin-bottom: 20px;
    }
    .nav button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    .nav .active {
      background-color: #007bff;
      color: white;
      border: none;
    }
    /* ë¶„ìˆ˜ ë¹„êµ ì—°ìŠµ í˜ì´ì§€ */
    #fraction-page {
      display: none;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .fraction, .percentage {
      display: inline-block;
      text-align: center;
      margin: 0 10px;
      padding: 10px;
      border: 2px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      font-size: 1.2em;
    }
    .fraction .numerator {
      display: block;
      border-bottom: 1px solid #000;
      padding: 0 4px;
    }
    .fraction .denominator {
      display: block;
      padding: 0 4px;
    }
    .selected {
      background-color: #add8e6;
      border-color: #007bff;
    }
    .problem {
      margin-bottom: 15px;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    .controls button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    .result {
      margin-top: 10px;
      font-weight: bold;
    }
    /* ê³±ì…ˆ ì—°ìŠµ í˜ì´ì§€ */
    #multiplication-page {
      display: none;
      margin-top: 40px;
    }
    .mul-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .numbers-container {
      text-align: center;
    }
    .numbers {
      display: inline-block;
      text-align: right;  /* ë‚´ë¶€ì˜ ìˆ«ìì™€ ì…ë ¥ë€ì„ ì˜¤ë¥¸ìª½ ì •ë ¬ */
      font-family: "Courier New", Courier, monospace; /* ëª¨ë…¸ìŠ¤í˜ì´ìŠ¤ í°íŠ¸ë¡œ ìë¦¿ìˆ˜ ì¼ì¹˜ */
    }
    .number {
      display: block;
      font-size: 2em;
      line-height: 1.2;
    }
    .input-feedback-container {
      display: inline-block;
      text-align: right;
      margin-top: 10px;
    }
    /* ì…ë ¥ë€ì€ ê³ ì • í­(5ch)ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë¬¸ì œë§ˆë‹¤ í­ì´ ë³€í•˜ì§€ ì•ŠìŒ */
    .answer-input {
      font-size: 2em;
      text-align: right;
      width: 5ch;
      position: relative;
      left: 42px;  
      font-family: "Courier New", Courier, monospace;
    }
    /* í”¼ë“œë°± ì•„ì´ì½˜ ì˜ì—­ì— ê³ ì • í­(24px)ì„ ë¶€ì—¬ */
    .feedback {
      display: inline-block;
      width: 24px;
      text-align: center;
      margin-left: 5px;
      position: relative;
      left: 30px;  
    }
    /* ìŠ¤í”¼ë„ˆ ì œê±° (Chrome, Safari, Edge, Opera) */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* ìŠ¤í”¼ë„ˆ ì œê±° (Firefox) */
    input[type=number] {
      -moz-appearance: textfield;
    }
    /* ëœë¤ë³€í™˜ í€´ì¦ˆ í˜ì´ì§€ ì¶”ê°€ */
    #random-transform-page {
      display: none;
      margin-top: 40px;
    }
    /* ë‚œì´ë„ ì„ íƒ ì˜ì—­ (ìˆœì„œ: ìƒ / í•˜ â†’ ìƒì´ ì™¼ìª½, í•˜ê°€ ì˜¤ë¥¸ìª½) */
    #rt-difficulty-container {
      text-align: center;
      margin-bottom: 10px;
    }
    /* ë³€í™˜ ì˜ˆì‹œ ì˜ì—­ */
    #random-transform-display {
      text-align: center;
      font-size: 1.5em;
      margin: 20px;
    }
    /* í•˜ ë‚œì´ë„ ì…ë ¥ ì˜ì—­ */
    #rt-low-inputs, 
    /* ìƒ ë‚œì´ë„ ì…ë ¥ ì˜ì—­ */
    #rt-high-inputs {
      text-align: center;
      margin: 10px;
    }
    #rt-low-inputs input[type="text"],
    #rt-high-inputs input[type="text"] {
      font-size: 1.2em;
      padding: 5px;
      width: 250px;
      margin-left: 10px;
    }
    /* ìƒ ë‚œì´ë„: ì¶œì œì½”ë“œ í‘œì‹œ ì˜ì—­ */
    #new-code-display {
      text-align: center;
      font-size: 1.5em;
      margin: 20px;
    }
  </style>
</head>
<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <div class="nav">
    <button id="btn-fraction" class="active">ë¶„ìˆ˜ ë¹„êµ ì—°ìŠµ</button>
    <button id="btn-multiplication">ê³±ì…ˆ ì—°ìŠµ</button>
    <button id="btn-random-transform">ë„ì‹ ì¶”ë¦¬ë¦¬</button>
  </div>

  <!-- ë¶„ìˆ˜ ë¹„êµ ì—°ìŠµ í˜ì´ì§€ (ê¸°ì¡´) -->
  <div id="fraction-page">
    <div class="header">
      <h1>ë¶„ìˆ˜ ë¹„êµ ì—°ìŠµ</h1>
      <p>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ë©´ ë°”ë¡œ ë¬¸ì œê°€ ìƒˆë¡œ ìƒì„±ë©ë‹ˆë‹¤.<br>
         ì•„ë˜ 15ë¬¸ì œì—ì„œ ë‘ ë¶„ìˆ˜ ì¤‘ ë” í° ë¶„ìˆ˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
      <label><input type="radio" name="difficulty" value="hard"> ìƒ</label>
      <label><input type="radio" name="difficulty" value="medium" checked> ì¤‘</label>
      <label><input type="radio" name="difficulty" value="easy"> í•˜</label>
    </div>
    <div id="problems"></div>
    <div class="controls">
      <button id="refresh">ë¬¸ì œ ìƒˆë¡œê³ ì¹¨</button>
      <button id="grade">ì±„ì </button>
      <div class="result" id="result"></div>
    </div>
  </div>

  <!-- ê³±ì…ˆ ì—°ìŠµ í˜ì´ì§€ (ê¸°ì¡´) -->
  <div id="multiplication-page">
    <div class="mul-header">
      <h1>ê³±ì…ˆ ì—°ìŠµ</h1>
      <p>ì•„ë˜ì˜ ê³±ì…ˆ ë¬¸ì œë¥¼ í’€ê³  ì—”í„°í‚¤ë¡œ ì •ë‹µì„ ì œì¶œí•˜ì„¸ìš”.</p>
    </div>
    <div class="numbers-container">
      <div class="numbers">
        <div id="lineA" class="number"></div>
        <div id="lineB" class="number"></div>
        <div class="input-feedback-container">
          <input type="number" id="answer-input" class="answer-input" placeholder="">
          <span id="feedback" class="feedback"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ëœë¤ë³€í™˜ í€´ì¦ˆ í˜ì´ì§€ ì¶”ê°€ -->
  <div id="random-transform-page">
    <div class="header">
      <h1>ë„ì‹ì¶”ë¦¬ë¦¬ í€´ì¦ˆ</h1>
      <p>ì˜ˆì‹œ ë³€í™˜ì„ ë³´ê³  ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
    </div>
    <!-- ë‚œì´ë„ ì„ íƒ (ìˆœì„œ: ìƒ / í•˜ â†’ ìƒì´ ì™¼ìª½, í•˜ê°€ ì˜¤ë¥¸ìª½) -->
    <div id="rt-difficulty-container">
      ë‚œì´ë„: 
      <label><input type="radio" name="rt-difficulty" value="ìƒ"> ìƒ</label>
      <label><input type="radio" name="rt-difficulty" value="í•˜" checked> í•˜</label>
    </div>
    <!-- ë³€í™˜ ì˜ˆì‹œ ì˜ì—­ (í•­ìƒ í‘œì‹œ) -->
    <div id="random-transform-display">
      <!-- ì˜ˆ: AB12 â†’ CD34 -->
    </div>
    <!-- í•˜ ë‚œì´ë„ ì…ë ¥ ì˜ì—­: ê¸°ì¡´ê³¼ ê°™ì´ ê·œì¹™ ì…ë ¥ -->
    <div id="rt-low-inputs">
      <div class="input-group">
        <label>ì¦ê°ë³€í™˜:</label>
        <input type="text" id="increment-input" placeholder="ì˜ˆ: 2 -1 3 -2">
      </div>
      <div class="input-group">
        <label>ìˆœì„œë³€í™˜:</label>
        <input type="text" id="order-input" placeholder="ì˜ˆ: 4213">
      </div>
    </div>
    <!-- ìƒ ë‚œì´ë„ ì…ë ¥ ì˜ì—­: ì¶œì œì½”ë“œ ì˜†ì— 'â†’ ?' í‘œì‹œ -->
    <div id="rt-high-inputs" style="display:none;">
      <div id="new-code-display">
        <!-- ì¶œì œì½”ë“œê°€ "ì¶œì œì½”ë“œ â†’ ?" í˜•ì‹ìœ¼ë¡œ í‘œì‹œë¨ -->
      </div>
      <div class="input-group">
        <label>ë³€í™˜ ê²°ê³¼:</label>
        <input type="text" id="high-answer-input" placeholder="ë³€í™˜ ê²°ê³¼ ì…ë ¥">
      </div>
    </div>
    <div style="text-align:center;">
      <button id="new-random-problem">ìƒˆ ë¬¸ì œ</button>
      <button id="grade-random-problem">ì±„ì </button>
    </div>
    <div id="random-feedback" style="text-align:center; font-weight:bold; margin-top:10px;"></div>
  </div>

  <script>
    /* ---------- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ (ë¶„ìˆ˜, ê³±ì…ˆ ì—°ìŠµ) ---------- */
    const MIN_DIFF_RATIO = 0.015; // 1.5%
    function randomNumber(isThreeDigit) {
      if (isThreeDigit) {
        return Math.floor(Math.random() * 900) + 100; // 100 ~ 999
      } else {
        return Math.floor(Math.random() * 9000) + 1000; // 1000 ~ 9999
      }
    }
    const presetPercentages = [5,15,20,25,50,75,80,85,110,115,120,125,150];
    function generateEasyFraction1() {
      const p = presetPercentages[Math.floor(Math.random() * presetPercentages.length)];
      const value1 = p / 100;
      const minDenom = Math.ceil(100 / value1);
      let denominator;
      const digitType = (Math.random() < 0.5 && minDenom <= 999) ? "3" : "4";
      if (digitType === "3") {
        do {
          denominator = randomNumber(true);
        } while (denominator < minDenom);
      } else {
        do {
          denominator = randomNumber(false);
        } while (denominator < minDenom);
      }
      let numerator = Math.round(value1 * denominator);
      if (numerator < 100) numerator = 100;
      return { frac: { numerator, denominator }, value: value1, preset: p };
    }
    function generateEasyFraction2(value1) {
      let attempts = 0;
      while (true) {
        attempts++;
        if (attempts > 1000) {
          let fallbackValue = value1 * 1.10;
          return generateEasyFraction2Core(fallbackValue);
        }
        const delta = (Math.random() * 2 - 1) * 0.10;
        const targetValue2 = value1 * (1 + delta);
        if (Math.abs(targetValue2 - value1) / value1 < MIN_DIFF_RATIO) {
          continue;
        }
        return generateEasyFraction2Core(targetValue2);
      }
    }
    function generateEasyFraction2Core(targetValue2) {
      const minDenom = Math.ceil(100 / targetValue2);
      const digitType = (Math.random() < 0.5 && minDenom <= 999) ? "3" : "4";
      let denominator;
      if (digitType === "3") {
        do {
          denominator = randomNumber(true);
        } while (denominator < minDenom);
      } else {
        do {
          denominator = randomNumber(false);
        } while (denominator < minDenom);
      }
      let numerator = Math.round(targetValue2 * denominator);
      if (numerator < 100) numerator = 100;
      return { numerator, denominator, value: targetValue2 };
    }
    function generateFraction() {
      return {
        numerator: (Math.random() < 0.5 ? randomNumber(true) : randomNumber(false)),
        denominator: (Math.random() < 0.5 ? randomNumber(true) : randomNumber(false))
      };
    }
    function generateCloseFractionValue(baseFraction, difficulty) {
      const baseValue = baseFraction.numerator / baseFraction.denominator;
      const errorRange = (difficulty === 'hard') ? 0.05 : 0.15;
      let attempts = 0;
      while (true) {
        attempts++;
        if (attempts > 1000) {
          return { numerator: baseFraction.numerator, denominator: baseFraction.denominator };
        }
        const error = (Math.random() * 2 - 1) * errorRange;
        const targetValue = baseValue * (1 + error);
        if (Math.abs(targetValue - baseValue) / baseValue < MIN_DIFF_RATIO) {
          continue;
        }
        const fraction2 = tryBuildFraction2(targetValue, baseFraction);
        if (fraction2) return fraction2;
      }
    }
    function tryBuildFraction2(targetValue, baseFraction) {
      let attempts2 = 0;
      while (attempts2 < 1000) {
        attempts2++;
        const forceCross = Math.random() < 0.8;
        if (forceCross) {
          if (Math.random() < 0.5) {
            const denominator = randomNumber(false);
            const numerator = Math.round(targetValue * denominator);
            if (numerator >= 100 && numerator <= 999) return { numerator, denominator };
          } else {
            const denominator = randomNumber(true);
            const numerator = Math.round(targetValue * denominator);
            if (numerator >= 100 && numerator <= 9999) return { numerator, denominator };
          }
        } else {
          const denomIsThree = Math.random() < 0.5;
          const denominator = denomIsThree ? randomNumber(true) : randomNumber(false);
          const numerator = Math.round(targetValue * denominator);
          if (numerator >= 100 && numerator <= 9999) return { numerator, denominator };
        }
      }
      return null;
    }
    function generateProblem(difficulty) {
      let frac1, frac2, answer;
      if (difficulty === 'easy') {
        const result1 = generateEasyFraction1();
        frac1 = result1.frac;
        const value1 = result1.value;
        const preset = result1.preset;
        const result2 = generateEasyFraction2(value1);
        frac2 = { numerator: result2.numerator, denominator: result2.denominator };
        answer = (value1 > result2.value) ? "first" : "second";
        return { frac1, frac2, answer, userAnswer: null, difficulty, preset };
      } else {
        do { frac1 = generateFraction(); }
        while (frac1.numerator / frac1.denominator < 0.5 || frac1.numerator / frac1.denominator > 2);
        const fraction2 = generateCloseFractionValue(frac1, difficulty);
        frac2 = { numerator: fraction2.numerator, denominator: fraction2.denominator };
        const val1 = frac1.numerator / frac1.denominator;
        const val2 = frac2.numerator / frac2.denominator;
        answer = (val1 > val2) ? "first" : "second";
        return { frac1, frac2, answer, userAnswer: null, difficulty };
      }
    }
    let problems = [];
    function createFractionButton(fraction, problemIndex, fractionSide) {
      const problem = problems[problemIndex];
      if (problem.difficulty === 'easy' && fractionSide === "first") {
        const btn = document.createElement('div');
        btn.className = 'percentage';
        btn.textContent = problem.preset + "%";
        btn.addEventListener('click', function() {
          selectAnswer(problemIndex, btn, fractionSide);
        });
        return btn;
      } else {
        const btn = document.createElement('div');
        btn.className = 'fraction';
        const numSpan = document.createElement('span');
        numSpan.className = 'numerator';
        numSpan.textContent = fraction.numerator;
        btn.appendChild(numSpan);
        const denSpan = document.createElement('span');
        denSpan.className = 'denominator';
        denSpan.textContent = fraction.denominator;
        btn.appendChild(denSpan);
        btn.addEventListener('click', function() {
          selectAnswer(problemIndex, btn, fractionSide);
        });
        return btn;
      }
    }
    function selectAnswer(problemIndex, btn, fractionSide) {
      const problemDiv = document.getElementById('problem-' + problemIndex);
      const allButtons = problemDiv.querySelectorAll('.fraction, .percentage');
      allButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      problems[problemIndex].userAnswer = fractionSide;
    }
    function renderProblems() {
      const problemsDiv = document.getElementById('problems');
      problemsDiv.innerHTML = '';
      problems.forEach((problem, index) => {
        const div = document.createElement('div');
        div.className = 'problem';
        div.id = 'problem-' + index;
        const frac1Btn = createFractionButton(problem.frac1, index, "first");
        const frac2Btn = createFractionButton(problem.frac2, index, "second");
        div.appendChild(frac1Btn);
        div.appendChild(frac2Btn);
        problemsDiv.appendChild(div);
      });
    }
    function generateProblems() {
      const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
      problems = [];
      for (let i = 0; i < 15; i++) {
        problems.push(generateProblem(difficulty));
      }
      renderProblems();
      document.getElementById('result').textContent = "";
    }
    function gradeProblems() {
      let correctCount = 0;
      problems.forEach((problem, index) => {
        const problemDiv = document.getElementById('problem-' + index);
        if (problem.userAnswer === problem.answer) {
          correctCount++;
          problemDiv.style.backgroundColor = '#d4edda';
        } else {
          problemDiv.style.backgroundColor = '#f8d7da';
        }
      });
      document.getElementById('result').textContent = "ì •ë‹µ: " + correctCount + " / 15";
    }
    document.getElementById('refresh').addEventListener('click', generateProblems);
    document.getElementById('grade').addEventListener('click', gradeProblems);
    document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
      radio.addEventListener('change', generateProblems);
    });

    /* ---------- ê³±ì…ˆ ì—°ìŠµ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ---------- */
    function generateMulProblem() {
      const a = Math.floor(Math.random() * 98) + 2; // 2 ~ 99
      const b = Math.floor(Math.random() * 18) + 2; // 2 ~ 19
      currentProblem = { a, b, answer: a * b };
      displayMulProblem();
    }
    function displayMulProblem() {
      const aStr = currentProblem.a.toString();
      const bStr = currentProblem.b.toString();
      const maxLen = Math.max(aStr.length, bStr.length);
      document.getElementById('lineA').textContent = aStr.padStart(maxLen, ' ');
      document.getElementById('lineB').textContent = bStr.padStart(maxLen, ' ');
      const inputElem = document.getElementById('answer-input');
      inputElem.value = '';
      inputElem.focus();
      document.getElementById('feedback').textContent = '';
    }
    function checkMulAnswer() {
      const inputElem = document.getElementById('answer-input');
      const feedbackElem = document.getElementById('feedback');
      const userAnswer = parseInt(inputElem.value, 10);
      if (userAnswer === currentProblem.answer) {
        feedbackElem.textContent = 'ğŸŸ¢';
        setTimeout(generateMulProblem, 500);
      } else {
        feedbackElem.textContent = 'âŒ';
        inputElem.focus();
      }
    }
    document.getElementById('answer-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        checkMulAnswer();
      }
    });

    /* ---------- ëœë¤ë³€í™˜ í€´ì¦ˆ ìŠ¤í¬ë¦½íŠ¸ ---------- */
    // Helper: ë°°ì—´ ì„ê¸°
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    // Helper: ì•ŒíŒŒë²³ ì‹œí”„íŠ¸ (ìˆœí™˜ ì²˜ë¦¬)
    function shiftLetter(letter, shift) {
      const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      let index = alpha.indexOf(letter);
      index = (index + shift + 26) % 26;
      return alpha[index];
    }
    // ì „ì—­ ë³€ìˆ˜ë“¤
    let currentTransformType; // "ì¦ê°" ë˜ëŠ” "ìˆœì„œ"
    let currentOriginalCode = "";
    let currentTransformedCode = "";
    let expectedIncrementRule = ""; // ì˜ˆ: "2 -1 3 -2"
    let expectedOrderRule = "";     // ì˜ˆ: "4213"
    // ìƒ ë‚œì´ë„ìš© ì „ì—­ ë³€ìˆ˜
    let currentRTDifficulty = "í•˜";
    let currentIncrementTypes = [];   // ê° ìë¦¬ì˜ íƒ€ì… ("digit" ë˜ëŠ” "letter")
    let currentIncrementShifts = [];  // ê° ìë¦¬ì˜ ì¦ê°ê°’
    let expectedHighAnswer = "";      // ìƒ ë‚œì´ë„ì¼ ë•Œ, ì¶œì œì½”ë“œì— ì ìš©í•œ ê²°ê³¼

    // ê¸°ë³¸ ì½”ë“œ ìƒì„± (ìˆ«ì2, ì•ŒíŒŒë²³2, ì¤‘ë³µ ì—†ì´)
    function generateBasicCode() {
      let digits = [];
      while (digits.length < 2) {
        let d = Math.floor(Math.random() * 10);
        if (!digits.includes(d)) digits.push(d);
      }
      let letters = [];
      const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      while (letters.length < 2) {
        let ch = alpha[Math.floor(Math.random()*26)];
        if (!letters.includes(ch)) letters.push(ch);
      }
      let codeArr = digits.concat(letters);
      shuffleArray(codeArr);
      return codeArr.join("");
    }

    // ì¦ê°ë³€í™˜ ë¬¸ì œ ìƒì„± (ì˜ˆì‹œìš©)
    function generateIncrementProblem() {
      let types = ["digit", "digit", "letter", "letter"];
      shuffleArray(types);
      let originalArr = [];
      let transformedArr = [];
      let incrementRules = [];
      const allowedShifts = [-4, -3, -2, -1, 1, 2, 3, 4];
      let chosenDigits = [];
      let chosenLetters = [];
      currentIncrementTypes = types.slice();
      for (let i = 0; i < 4; i++) {
        if (types[i] === "digit") {
          let valid = false, shift, origDigit;
          for (let attempt = 0; attempt < 100; attempt++) {
            shift = allowedShifts[Math.floor(Math.random() * allowedShifts.length)];
            let minVal = (shift < 0) ? Math.abs(shift) : 0;
            let maxVal = (shift > 0) ? (9 - shift) : 9;
            let possible = [];
            for (let d = minVal; d <= maxVal; d++) {
              if (!chosenDigits.includes(d)) possible.push(d);
            }
            if (possible.length > 0) {
              origDigit = possible[Math.floor(Math.random() * possible.length)];
              valid = true;
              break;
            }
          }
          if (!valid) {
            let possible = [];
            for (let d = 0; d <= 9; d++) {
              if (!chosenDigits.includes(d)) possible.push(d);
            }
            origDigit = possible[Math.floor(Math.random() * possible.length)];
            shift = 1;
          }
          chosenDigits.push(origDigit);
          originalArr.push(origDigit.toString());
          transformedArr.push((origDigit + shift).toString());
          incrementRules.push(shift);
        } else { // letter
          const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          let possibleLetters = [];
          for (let j = 0; j < alpha.length; j++) {
            let ch = alpha[j];
            if (!chosenLetters.includes(ch)) possibleLetters.push(ch);
          }
          let origLetter = possibleLetters[Math.floor(Math.random() * possibleLetters.length)];
          chosenLetters.push(origLetter);
          let shift = allowedShifts[Math.floor(Math.random() * allowedShifts.length)];
          originalArr.push(origLetter);
          transformedArr.push(shiftLetter(origLetter, shift));
          incrementRules.push(shift);
        }
      }
      currentOriginalCode = originalArr.join("");
      currentTransformedCode = transformedArr.join("");
      expectedIncrementRule = incrementRules.map(v => v.toString()).join(" ");
      currentIncrementShifts = incrementRules.slice();
    }

    // ìˆœì„œë³€í™˜ ë¬¸ì œ ìƒì„± (ì˜ˆì‹œìš©)
    function generateOrderProblem() {
      currentOriginalCode = generateBasicCode();
      let positions;
      let validPermutation = false;
      while (!validPermutation) {
        positions = [1, 2, 3, 4];
        shuffleArray(positions);
        let diffCount = positions.reduce((count, pos, idx) => {
          return count + (pos !== idx + 1 ? 1 : 0);
        }, 0);
        if (diffCount >= 3) validPermutation = true;
      }
      expectedOrderRule = positions.join("");
      let originalArr = currentOriginalCode.split("");
      currentTransformedCode = positions.map(pos => originalArr[pos - 1]).join("");
    }

    // ìƒ ë‚œì´ë„: ì¦ê° ë³€í™˜ ì¶œì œì½”ë“œ ìƒì„± (ê°™ì€ íƒ€ì… ë° ì¦ê° rule ì‚¬ìš©)
    function generateNewIncrementForHigh() {
      let newOriginalArr = [];
      let newTransformedArr = [];
      const allowedShifts = currentIncrementShifts;
      let chosenDigits = [];
      let chosenLetters = [];
      const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      for (let i = 0; i < 4; i++) {
        if (currentIncrementTypes[i] === "digit") {
          let shift = allowedShifts[i];
          let minVal = (shift < 0) ? Math.abs(shift) : 0;
          let maxVal = (shift > 0) ? (9 - shift) : 9;
          let possible = [];
          for (let d = minVal; d <= maxVal; d++) {
            if (!chosenDigits.includes(d)) possible.push(d);
          }
          let origDigit = possible[Math.floor(Math.random() * possible.length)];
          chosenDigits.push(origDigit);
          newOriginalArr.push(origDigit.toString());
          newTransformedArr.push((origDigit + shift).toString());
        } else {
          let possibleLetters = [];
          for (let j = 0; j < alpha.length; j++) {
            let ch = alpha[j];
            if (!chosenLetters.includes(ch)) possibleLetters.push(ch);
          }
          let origLetter = possibleLetters[Math.floor(Math.random() * possibleLetters.length)];
          chosenLetters.push(origLetter);
          newOriginalArr.push(origLetter);
          let shift = allowedShifts[i];
          newTransformedArr.push(shiftLetter(origLetter, shift));
        }
      }
      return {
        original: newOriginalArr.join(""),
        transformed: newTransformedArr.join("")
      };
    }

    // ìƒ ë‚œì´ë„: ìˆœì„œ ë³€í™˜ ì¶œì œì½”ë“œ ìƒì„± (ê¸°ì¡´ rule ì ìš©)
    function generateNewOrderForHigh() {
      let newOriginal = generateBasicCode();
      let originalArr = newOriginal.split("");
      let newTransformed = expectedOrderRule.split("").map(pos => originalArr[pos - 1]).join("");
      return { original: newOriginal, transformed: newTransformed };
    }

    // ëœë¤ë³€í™˜ ë¬¸ì œ ìƒì„± (ë‚œì´ë„ì— ë”°ë¼ ë¶„ê¸°)
    function generateRandomTransformProblem() {
      currentRTDifficulty = document.querySelector('input[name="rt-difficulty"]:checked').value;
      if (currentRTDifficulty === "í•˜") {
        document.getElementById("rt-low-inputs").style.display = "block";
        document.getElementById("rt-high-inputs").style.display = "none";
        currentTransformType = (Math.random() < 0.5) ? "ì¦ê°" : "ìˆœì„œ";
        if (currentTransformType === "ì¦ê°") {
          generateIncrementProblem();
        } else {
          generateOrderProblem();
        }
        document.getElementById("random-transform-display").textContent = currentOriginalCode + " â†’ " + currentTransformedCode;
        document.getElementById("increment-input").value = "";
        document.getElementById("order-input").value = "";
      } else {
        document.getElementById("rt-low-inputs").style.display = "none";
        document.getElementById("rt-high-inputs").style.display = "block";
        currentTransformType = (Math.random() < 0.5) ? "ì¦ê°" : "ìˆœì„œ";
        if (currentTransformType === "ì¦ê°") {
          generateIncrementProblem();
          document.getElementById("random-transform-display").textContent = currentOriginalCode + " â†’ " + currentTransformedCode;
          const newPair = generateNewIncrementForHigh();
          document.getElementById("new-code-display").textContent = newPair.original + " â†’ ?";
          expectedHighAnswer = newPair.transformed;
        } else {
          generateOrderProblem();
          document.getElementById("random-transform-display").textContent = currentOriginalCode + " â†’ " + currentTransformedCode;
          const newPair = generateNewOrderForHigh();
          document.getElementById("new-code-display").textContent = newPair.original + " â†’ ?";
          expectedHighAnswer = newPair.transformed;
        }
        document.getElementById("high-answer-input").value = "";
      }
      document.getElementById("random-feedback").textContent = "";
    }

    // ì—”í„°í‚¤ ì œì¶œ ì´ë²¤íŠ¸ (í•˜ ë‚œì´ë„)
    document.getElementById("increment-input").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        gradeRandomTransformProblem();
      }
    });
    document.getElementById("order-input").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        gradeRandomTransformProblem();
      }
    });
    // ì—”í„°í‚¤ ì œì¶œ ì´ë²¤íŠ¸ (ìƒ ë‚œì´ë„)
    document.getElementById("high-answer-input").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        gradeRandomTransformProblem();
      }
    });

    function gradeRandomTransformProblem() {
      let feedback = "";
      if (currentRTDifficulty === "í•˜") {
        if (currentTransformType === "ì¦ê°") {
          let userInput = document.getElementById("increment-input").value.trim();
          let userRules = userInput.split(/\s+/);
          let expectedRules = expectedIncrementRule.split(" ");
          if (userRules.length !== 4) {
            feedback = "ì¦ê°ë³€í™˜ ë‹µì€ 4ê°œì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.";
          } else {
            let correct = true;
            for (let i = 0; i < 4; i++) {
              if (parseInt(userRules[i], 10) !== parseInt(expectedRules[i], 10)) {
                correct = false;
                break;
              }
            }
            if (correct) {
              feedback = "ğŸŸ¢";
              document.getElementById("random-feedback").textContent = feedback;
              setTimeout(generateRandomTransformProblem, 300);
              return;
            } else {
              feedback = "âŒ ì˜¤ë‹µ. ì •ë‹µ: " + expectedIncrementRule;
            }
          }
        } else {
          let userInput = document.getElementById("order-input").value.trim();
          if (userInput === expectedOrderRule) {
            feedback = "ğŸŸ¢";
            document.getElementById("random-feedback").textContent = feedback;
            setTimeout(generateRandomTransformProblem, 300);
            return;
          } else {
            feedback = "âŒ ì˜¤ë‹µ. ì •ë‹µ: " + expectedOrderRule;
          }
        }
      } else {
        let userInput = document.getElementById("high-answer-input").value.trim();
        if (userInput === expectedHighAnswer) {
          feedback = "ğŸŸ¢";
          document.getElementById("random-feedback").textContent = feedback;
          setTimeout(generateRandomTransformProblem, 300);
          return;
        } else {
          feedback = "âŒ ì˜¤ë‹µ. ì •ë‹µ: " + expectedHighAnswer;
        }
      }
      document.getElementById("random-feedback").textContent = feedback;
    }

    // ë‚œì´ë„ ë¼ë””ì˜¤ ë²„íŠ¼ (rt-difficulty) ë³€ê²½ ì‹œ ìë™ ìƒˆ ë¬¸ì œ ìƒì„±
    document.querySelectorAll('input[name="rt-difficulty"]').forEach(radio => {
      radio.addEventListener("change", generateRandomTransformProblem);
    });

    /* ---------- í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜ ---------- */
    function showFractionPage() {
      document.getElementById("fraction-page").style.display = "block";
      document.getElementById("multiplication-page").style.display = "none";
      document.getElementById("random-transform-page").style.display = "none";
      document.getElementById("btn-fraction").classList.add("active");
      document.getElementById("btn-multiplication").classList.remove("active");
      document.getElementById("btn-random-transform").classList.remove("active");
      generateProblems();
    }
    function showMultiplicationPage() {
      document.getElementById("fraction-page").style.display = "none";
      document.getElementById("multiplication-page").style.display = "block";
      document.getElementById("random-transform-page").style.display = "none";
      document.getElementById("btn-multiplication").classList.add("active");
      document.getElementById("btn-fraction").classList.remove("active");
      document.getElementById("btn-random-transform").classList.remove("active");
      generateMulProblem();
    }
    function showRandomTransformPage() {
      document.getElementById("fraction-page").style.display = "none";
      document.getElementById("multiplication-page").style.display = "none";
      document.getElementById("random-transform-page").style.display = "block";
      document.getElementById("btn-random-transform").classList.add("active");
      document.getElementById("btn-fraction").classList.remove("active");
      document.getElementById("btn-multiplication").classList.remove("active");
      generateRandomTransformProblem();
    }
    document.getElementById("btn-fraction").addEventListener("click", showFractionPage);
    document.getElementById("btn-multiplication").addEventListener("click", showMultiplicationPage);
    document.getElementById("btn-random-transform").addEventListener("click", showRandomTransformPage);
    document.getElementById("new-random-problem").addEventListener("click", generateRandomTransformProblem);
    document.getElementById("grade-random-problem").addEventListener("click", gradeRandomTransformProblem);

    // ê¸°ë³¸ í˜ì´ì§€ëŠ” ë¶„ìˆ˜ ë¹„êµ ì—°ìŠµ í˜ì´ì§€
    showFractionPage();
  </script>
</body>
</html>
